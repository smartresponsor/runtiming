# Copyright (c) 2025 Oleksandr Tishchenko / Marketing America Corp
name: build-test-gate

on:
  push:
  pull_request:

jobs:
  build-test-gate:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup PHP + Composer cache
        uses: ./.github/actions/php-runtime-setup
        with:
          php-version: '8.4'
          install-deps: 'true'

      - name: Fetch PHPUnit
        env:
          PHPUNIT_VERSION: '10.5.19'
        run: |
          curl -fsSL -o phpunit.phar "https://github.com/sebastianbergmann/phpunit/releases/download/${PHPUNIT_VERSION}/phpunit-${PHPUNIT_VERSION}.phar"
          curl -fsSL -o phpunit.phar.sha256 "https://github.com/sebastianbergmann/phpunit/releases/download/${PHPUNIT_VERSION}/phpunit-${PHPUNIT_VERSION}.phar.sha256"
          sha256sum -c phpunit.phar.sha256

      - name: Run unit tests
        run: |
          mkdir -p report/runtime/ci
          php phpunit.phar --bootstrap tools/runtime/phpunit-bootstrap.php --log-junit report/runtime/ci/junit.xml Test

      - name: Run runtime gate
        run: |
          export RUNTIME_GATE_OUT_DIR="${GITHUB_WORKSPACE}/report/runtime/ci/gate"
          bash tools/runtime/gate/run-rc-gate.sh

      - name: Upload CI evidence artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-test-gate-evidence
          if-no-files-found: warn
          path: |
            report/runtime/ci/junit.xml
            report/runtime/ci/gate/**
