# Copyright (c) 2025 Oleksandr Tishchenko / Marketing America Corp
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: runtime-supercharger-alert-rule
  labels:
    app: runtime-supercharger
spec:
  groups:
    - name: runtime-supercharger.rules
      rules:
        - alert: RuntimeSuperchargerResetFailure
          expr: increase(runtime_supercharger_reset_total{result="fail"}[10m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Runtime Supercharger reset failures detected"
            description: "At least one reset failure occurred in the last 10 minutes. Inspect resetter chain and logs."

        - alert: RuntimeSuperchargerResetStorm
          expr: increase(runtime_supercharger_reset_total[5m]) > 10
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Runtime Supercharger resets too frequent"
            description: "More than 10 resets within 5 minutes for 10 minutes. Check memory growth, request limit, and recycle policy."

        - alert: RuntimeSuperchargerRssHigh
          expr: runtime_supercharger_rss_memory_mb > 1500
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Runtime worker RSS memory high"
            description: "RSS memory above 1500MB for 15 minutes. Tighten recycle thresholds and review leak suspects."

        - alert: RuntimeSuperchargerUptimeFlapping
          expr: avg_over_time(runtime_supercharger_uptime_sec[5m]) < 120
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Runtime worker uptime too low"
            description: "Average uptime below 120s for 15 minutes. Indicates frequent restarts/recycles."

        - alert: RuntimeSuperchargerResetDurationSlow
          expr: (rate(runtime_supercharger_reset_duration_seconds_sum[5m]) / clamp_min(rate(runtime_supercharger_reset_duration_seconds_count[5m]), 1)) > 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Runtime reset average duration high"
            description: "Average reset duration above 1s for 10 minutes. Review expensive resetters (e.g. container reset)."
